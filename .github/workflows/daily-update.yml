name: AIæ¯æ—¥å‰æ²¿ - è‡ªåŠ¨æ›´æ–°

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 7:00ï¼ˆUTC 23:00 å‰ä¸€å¤©ï¼‰
  schedule:
    - cron: '0 23 * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

# è®¾ç½®æƒé™ï¼Œå…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªéƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      # 4. è¿è¡Œä¸»ç¨‹åºï¼ˆæŠ“å–RSS + AIå¤„ç† + ç”ŸæˆHTMLï¼‰
      - name: ğŸš€ è¿è¡Œä¸»ç¨‹åº
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          MAX_ARTICLES_PER_DAY: '50'
          RUN_TIME: '07:00'
          TIMEZONE: 'Asia/Shanghai'
          LOG_LEVEL: 'INFO'
          SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
        run: python main.py once

      # 5. æŸ¥çœ‹ç”Ÿæˆç»“æœ
      - name: ğŸ“‹ æ£€æŸ¥è¾“å‡º
        run: |
          echo "=== è¾“å‡ºç›®å½•å†…å®¹ ==="
          ls -la output/
          echo "=== index.html å¤§å° ==="
          wc -c output/index.html || echo "æœªæ‰¾åˆ° index.html"

      # 6. é…ç½® GitHub Pages
      - name: ğŸ“„ é…ç½® Pages
        uses: actions/configure-pages@v4

      # 7. ä¸Šä¼ åˆ° Pages
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: './output'

      # 8. éƒ¨ç½²åˆ° GitHub Pages
      - name: ğŸŒ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
